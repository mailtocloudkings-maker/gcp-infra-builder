name: GCP Non-Prod Infra Builder

on:
  workflow_dispatch:
    inputs:
      firewall:
        description: "Firewall"
        type: boolean
        default: true
      compute_vm:
        description: "Compute VM"
        type: boolean
        default: false
      compute_mig:
        description: "Compute MIG"
        type: boolean
        default: false
      cloudsql:
        description: "CloudSQL"
        type: boolean
        default: false
      storage:
        description: "Storage Bucket"
        type: boolean
        default: false
      ilb:
        description: "Internal Load Balancer"
        type: boolean
        default: false
      monitoring:
        description: "Monitoring"
        type: boolean
        default: false
      alerts:
        description: "Alerts"
        type: boolean
        default: false
      dashboards:
        description: "Dashboards"
        type: boolean
        default: false
      dns_internal:
        description: "Internal DNS"
        type: boolean
        default: false

jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - uses: actions/checkout@v4

      # 2️⃣ Authenticate to GCP
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 3️⃣ Setup Terraform CLI
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.6"

      # 4️⃣ Terraform Init
      - name: Terraform Init
        working-directory: terraform/environments/non-prod/gcp
        run: terraform init -input=false

      # 5️⃣ Terraform Plan (only shows what will be created)
      - name: Terraform Plan
        working-directory: terraform/environments/non-prod/gcp
        run: |
          terraform plan -input=false \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="region=${{ secrets.GCP_REGION }}" \
            -var="zone=${{ secrets.GCP_ZONE }}" \
            -var="create_firewall=${{ inputs.firewall }}" \
            -var="create_compute_vm=${{ inputs.compute_vm }}" \
            -var="create_compute_mig=${{ inputs.compute_mig }}" \
            -var="create_cloudsql=${{ inputs.cloudsql }}" \
            -var="create_storage=${{ inputs.storage }}" \
            -var="create_ilb=${{ inputs.ilb }}" \
            -var="create_monitoring=${{ inputs.monitoring }}" \
            -var="create_alerts=${{ inputs.alerts }}" \
            -var="create_dns_internal=${{ inputs.dns_internal }}" \
            -var="create_dashboards=${{ inputs.dashboards }}"

      # 6️⃣ Terraform Apply
      - name: Terraform Apply
        working-directory: terraform/environments/non-prod/gcp
        run: |
          terraform apply -auto-approve -input=false \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="region=${{ secrets.GCP_REGION }}" \
            -var="zone=${{ secrets.GCP_ZONE }}" \
            -var="create_firewall=${{ inputs.firewall }}" \
            -var="create_compute_vm=${{ inputs.compute_vm }}" \
            -var="create_compute_mig=${{ inputs.compute_mig }}" \
            -var="create_cloudsql=${{ inputs.cloudsql }}" \
            -var="create_storage=${{ inputs.storage }}" \
            -var="create_ilb=${{ inputs.ilb }}" \
            -var="create_monitoring=${{ inputs.monitoring }}" \
            -var="create_alerts=${{ inputs.alerts }}" \
            -var="create_dns_internal=${{ inputs.dns_internal }}" \
            -var="create_dashboards=${{ inputs.dashboards }}"

      # 7️⃣ Show Terraform Outputs
      - name: Show Terraform Outputs
        working-directory: terraform/environments/non-prod/gcp
        run: |
          echo "==== Terraform Outputs ===="
          terraform output -json
